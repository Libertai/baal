---
/**
 * NetworkMap — live CRN world map with deployment feed.
 *
 * The world map SVG paths are generated at BUILD TIME from Natural Earth 110m
 * data (world-atlas + topojson-client). Zero JS is shipped for the map itself.
 *
 * Client-side JS fetches live CRN geo data from the LiberClaw API,
 * plots dots at real coordinates, and animates a deployment activity feed.
 */

// @ts-expect-error — world-atlas ships JSON, no types
import land110m from "world-atlas/land-110m.json";
import * as topojson from "topojson-client";

// ── Build-time: convert TopoJSON → SVG paths ───────────────────────

const VB_W = 1000;
const VB_H = 500;

function project(lng: number, lat: number): [number, number] {
  const x = ((lng + 180) / 360) * VB_W;
  const y = ((90 - lat) / 180) * VB_H;
  return [x, y];
}

function ringToPath(ring: number[][]): string {
  return ring
    .map((coord, i) => {
      const [x, y] = project(coord[0], coord[1]);
      return `${i === 0 ? "M" : "L"}${x.toFixed(1)},${y.toFixed(1)}`;
    })
    .join(" ") + " Z";
}

function geometryToPath(geometry: any): string {
  if (geometry.type === "Polygon") {
    return geometry.coordinates.map(ringToPath).join(" ");
  }
  if (geometry.type === "MultiPolygon") {
    return geometry.coordinates
      .map((polygon: number[][][]) => polygon.map(ringToPath).join(" "))
      .join(" ");
  }
  return "";
}

const landFeature = topojson.feature(land110m as any, (land110m as any).objects.land);
const features = "features" in landFeature ? landFeature.features : [landFeature];
const mapPaths = features.map((f: any) => geometryToPath(f.geometry));

// API URL — configurable, falls back to direct CRN list
const API_URL = import.meta.env.PUBLIC_API_URL || "https://api.liberclaw.io";
---

<div class="glass-widget p-1 overflow-hidden relative flex flex-col" id="network-map">
  <div class="absolute inset-0 bg-[#050505] z-0 map-grid"></div>
  <div class="scan-line"></div>

  <!-- Header -->
  <div class="relative z-10 p-6 border-b border-white/10 bg-background-dark/80 backdrop-blur-sm flex justify-between items-center">
    <div class="flex items-center gap-4">
      <span class="material-icons-round text-claw-orange animate-pulse">public</span>
      <h2 class="text-xl font-bold text-white uppercase tracking-wider">Live Agent Network</h2>
    </div>
    <div class="flex gap-6 text-xs font-mono text-slate-400">
      <div class="flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-green-500"></span>
        <span id="crn-count">--</span> CRNs Online
      </div>
      <div class="flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-claw-orange animate-pulse"></span>
        LIVE
      </div>
    </div>
  </div>

  <!-- Map -->
  <div class="relative z-10 flex-grow min-h-[400px]">
    <svg
      id="world-map"
      viewBox={`0 0 ${VB_W} ${VB_H}`}
      class="w-full h-full"
      preserveAspectRatio="xMidYMid meet"
      xmlns="http://www.w3.org/2000/svg"
    >
      <!-- Real world map (built at compile time) -->
      <g class="opacity-[0.08]" fill="#ff5e00" stroke="none">
        {mapPaths.map((d: string) => (
          <path d={d} />
        ))}
      </g>

      <!-- CRN node group (populated by client JS) -->
      <g id="crn-nodes"></g>

      <!-- Pulse rings (animated highlights) -->
      <g id="pulse-rings"></g>
    </svg>
  </div>

  <!-- Activity Feed -->
  <div class="relative z-10 border-t border-white/10 bg-background-dark/90 backdrop-blur-sm">
    <div class="flex items-stretch">
      <div class="flex-grow overflow-hidden px-6 py-3">
        <div id="feed" class="space-y-1">
          <div class="font-mono text-xs text-slate-500 animate-pulse">Connecting to network...</div>
        </div>
      </div>
      <div class="border-l border-white/10 px-6 py-3 flex items-center gap-6 font-mono text-xs text-slate-500 shrink-0">
        <div>LATENCY: <span class="text-white">12ms</span></div>
        <div>NODES: <span class="text-white" id="node-count-footer">--</span></div>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ VB_W, VB_H, API_URL }}>
  // ── Types ─────────────────────────────────────────────────────────
  const AGENT_NAMES = [
    "CodeBuddy", "Researcher", "SysAdmin", "DataAnalyst", "ContentGen",
    "APIMonitor", "DocWriter", "TestRunner", "LogParser", "Translator",
    "Summarizer", "WebScraper", "TaskPlanner", "MailBot", "ChatAssist",
  ];

  const ACTIONS = [
    "deployed to", "migrated to", "scaled up on", "restarted on",
    "health check passed on",
  ];

  // ── State ─────────────────────────────────────────────────────────
  let crnNodes = []; // { name, lat, lng, cx, cy, el }

  // ── Helpers ───────────────────────────────────────────────────────
  function pick(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function rand(min, max) {
    return Math.random() * (max - min) + min;
  }

  function project(lng, lat) {
    return [
      ((lng + 180) / 360) * VB_W,
      ((90 - lat) / 180) * VB_H,
    ];
  }

  // ── Render CRN dots at real coordinates ───────────────────────────
  function renderNodes(nodes) {
    const svgNS = "http://www.w3.org/2000/svg";
    const group = document.getElementById("crn-nodes");
    group.innerHTML = "";
    crnNodes = [];

    for (const node of nodes) {
      const [cx, cy] = project(node.lng, node.lat);

      const circle = document.createElementNS(svgNS, "circle");
      circle.setAttribute("cx", String(cx));
      circle.setAttribute("cy", String(cy));
      circle.setAttribute("r", "2.5");
      circle.setAttribute("fill", "#22c55e");
      circle.setAttribute("opacity", "0.6");
      circle.style.transition = "all 0.5s ease";
      group.appendChild(circle);

      crnNodes.push({ ...node, cx, cy, el: circle });
    }
  }

  // ── Highlight a specific CRN ──────────────────────────────────────
  function highlightNode(node) {
    const svgNS = "http://www.w3.org/2000/svg";
    const pulseGroup = document.getElementById("pulse-rings");

    // Light up the dot
    node.el.setAttribute("fill", "#ff5e00");
    node.el.setAttribute("opacity", "1");
    node.el.setAttribute("r", "4");

    setTimeout(() => {
      node.el.setAttribute("fill", "#22c55e");
      node.el.setAttribute("opacity", "0.6");
      node.el.setAttribute("r", "2.5");
    }, 2500);

    // Expanding pulse ring
    const ring = document.createElementNS(svgNS, "circle");
    ring.setAttribute("cx", String(node.cx));
    ring.setAttribute("cy", String(node.cy));
    ring.setAttribute("r", "4");
    ring.setAttribute("fill", "none");
    ring.setAttribute("stroke", "#ff5e00");
    ring.setAttribute("stroke-width", "1.5");
    ring.setAttribute("opacity", "0.8");
    pulseGroup.appendChild(ring);

    let r = 4;
    let opacity = 0.8;
    const anim = setInterval(() => {
      r += 1.2;
      opacity -= 0.02;
      if (opacity <= 0) {
        clearInterval(anim);
        ring.remove();
        return;
      }
      ring.setAttribute("r", String(r));
      ring.setAttribute("opacity", String(opacity));
    }, 25);
  }

  // ── Feed ──────────────────────────────────────────────────────────
  function addFeedEntry(text) {
    const feed = document.getElementById("feed");
    const entry = document.createElement("div");
    entry.className = "font-mono text-xs flex items-center gap-2 opacity-0 transition-opacity duration-500";
    entry.innerHTML = `
      <span class="text-slate-600">${new Date().toLocaleTimeString("en-GB", { hour12: false })}</span>
      <span class="text-claw-orange">\u25b8</span>
      <span class="text-slate-300">${text}</span>
    `;

    while (feed.children.length >= 4) {
      feed.removeChild(feed.firstChild);
    }
    feed.appendChild(entry);

    requestAnimationFrame(() => {
      entry.classList.remove("opacity-0");
      entry.classList.add("opacity-100");
    });
  }

  function generateEvent() {
    if (crnNodes.length === 0) return;
    const node = pick(crnNodes);
    const agent = pick(AGENT_NAMES);
    const action = pick(ACTIONS);
    const location = node.city ? `${node.name} (${node.city})` : node.name;
    addFeedEntry(
      `<strong>${agent}</strong> ${action} <span class="text-claw-orange">${location}</span>`
    );
    highlightNode(node);
  }

  // ── Fetch data ────────────────────────────────────────────────────

  async function fetchFromAPI() {
    // Try our API first (has real geo coordinates)
    const resp = await fetch(`${API_URL}/api/v1/network/crns`);
    if (!resp.ok) throw new Error("API response not ok");
    const data = await resp.json();
    return data.nodes;
  }

  async function fetchFallback() {
    // Fallback: fetch raw CRN list and distribute by region heuristics
    const resp = await fetch("https://crns-list.aleph.sh/crns.json");
    const crns = await resp.json();
    const active = crns.filter(
      (c) => c.qemu_support && c.system_usage?.active && c.score >= 0.3
    );

    // Without geo data, scatter across known regions
    const regions = [
      { lat: 48.8, lng: 2.3, spread: 8, weight: 0.30 },   // Paris
      { lat: 50.1, lng: 8.7, spread: 5, weight: 0.25 },   // Frankfurt
      { lat: 52.4, lng: 4.9, spread: 4, weight: 0.10 },   // Amsterdam
      { lat: 39.0, lng: -77.5, spread: 6, weight: 0.10 },  // US East
      { lat: 45.5, lng: -122.7, spread: 5, weight: 0.05 }, // US West
      { lat: 35.7, lng: 139.7, spread: 5, weight: 0.08 },  // Tokyo
      { lat: 1.4, lng: 103.8, spread: 4, weight: 0.05 },   // Singapore
      { lat: -23.5, lng: -46.6, spread: 4, weight: 0.04 }, // São Paulo
      { lat: -33.9, lng: 151.2, spread: 4, weight: 0.03 }, // Sydney
    ];

    const nodes = [];
    for (const crn of active) {
      const region = regions[Math.floor(Math.random() * regions.length)];
      // Bias toward higher-weight regions
      const r = pick(regions.filter(() => Math.random() < 0.5) || [region]);
      nodes.push({
        name: crn.name || "Unknown",
        lat: r.lat + (Math.random() - 0.5) * r.spread,
        lng: r.lng + (Math.random() - 0.5) * r.spread,
      });
    }
    return nodes;
  }

  // ── Init ──────────────────────────────────────────────────────────
  async function init() {
    let nodes;
    try {
      nodes = await fetchFromAPI();
    } catch {
      try {
        nodes = await fetchFallback();
      } catch {
        // Hard fallback with synthetic data
        nodes = [];
      }
    }

    const count = nodes.length || "--";
    document.getElementById("crn-count").textContent = String(count);
    document.getElementById("node-count-footer").textContent = String(count);

    if (nodes.length > 0) {
      renderNodes(nodes);
    }

    // Clear loading message and start feed
    document.getElementById("feed").innerHTML = "";
    generateEvent();

    setInterval(() => {
      generateEvent();
    }, rand(3000, 6000));
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
</script>
